<html>
<head>
<script>

function escapeRegExp(str) {
    return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

function replaceAll(str, find, replace) {
  return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
}

function getNodeStart(node, source) {
	node_start = source.indexOf(node+":")-getIndentLevel(node,source);
	if (node_start == -1)
	{
		throw "ERROR:Node not Found!";
	}
	else
	{
		return node_start;
		}
}

function getIndentString(node,source) {
	pos = getNodeStart(node, source);
	//alert("Position in Indent Level funtion" + pos);
		
	//logic for zero indent level
	if (pos ==0) {
		return '';
		}
	if(source[pos-1] == '\n')
	{
		return '';
		}
		
	var i=1;
	indent_string = "";
	while(source[pos-i] != '\n')
	{
		//alert(source[pos-i]);
		if (source[pos-i] != ' ') {
			return -1;
		}
		i=i+1;
		indent_string=indent_string+" ";
	}
	return indent_string;
}

function getIndentLevel(node,source) {
	pos = source.indexOf(node+":"); //not using getNodeStart because getNodeStart requires getIndentLevel
	//alert("Position in Indent Level funtion" + pos);
	
	if (pos == -1)
	{
		throw "ERROR:Node not Found!";
	}
		
	//logic for zero indent level
	if (pos ==0) {
		return 0;
		}
	if(source[pos-1] == '\n')
	{
		return 0;
		}
		
	var i=1;
	indent_string = "";
	while(source[pos-i] != '\n')
	{
		//alert(source[pos-i]);
		if (source[pos-i] != ' ') {
			return -1;
		}
		i=i+1;
	}
	return i-1;
}

function getIndentLevel_UI() {
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	alert(getIndentLevel(node, source));
}

function getYAMLNodeEndRegEx(indent_level)
{
	return new RegExp('\n {0,'+indent_level+'}(?! )');
}
function getNextNode(node, source) {
	node_start = getNodeStart(node, source);
	indent_level = getIndentLevel(node, source);
	
	re = getYAMLNodeEndRegEx(indent_level);
	//alert('node start in get node function'  + node_start);
	next_node = node_start+source.substring(node_start).search(re)+indent_level+1;
	//alert(node_end);
	return next_node;
}

function getNodeEnd(node, source) {
	node_start = getNodeStart(node, source);
	indent_level = getIndentLevel(node, source);
	
	re = getYAMLNodeEndRegEx(indent_level);
	//alert('node start in get node function'  + node_start);
	
	node_end = node_start+source.substring(node_start).search(re);
	//alert(node_end);
	
	//handle last node case - this part requires better code and possibly refacting of the whole function
	if(node_end+1 == node_start)
	{
		node_end = source.length-1;
	}
	
	return node_end;
}

function getNextNode_UI() {
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	node_end = getNextNode(node, source);
	//alert("Node end position" + node_end);
	alert(source.substring(node_end, node_end+source.substring(node_end).indexOf(':')));
}

function extractNode(node, source) {
	node_start = getNodeStart(node, source);
	node_end = getNodeEnd(node, source);
	return source.substring(node_start,node_end+1);
}

function extractNode_UI() {
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	alert(extractNode(node, source));
}

function removeNode(node, source)
{	
	node_start = getNodeStart(node, source);
	node_end = getNodeEnd(node, source);
	
	return source.substring(0,node_start)+source.substring(node_end+1);
}

function removeNode_UI() {
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	edited_source = removeNode(node, source);
	document.getElementById("stack-yaml").value = edited_source;
}

function copyNode_UI() {
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	node_content = extractNode(node, source);
	document.getElementById("new-stack").value += node_content;
}

function getChildren(node, source) {
	node_contents = extractNode(node, source);
	child_indent_level = getIndentLevel(node, source)+2;
	match_regex_pattern = "\n {"+child_indent_level+","+child_indent_level+"}(?! ).*(?=:)";
	//alert(regex_pattern);
	//alert(node_contents);
	match_regex = new RegExp(match_regex_pattern,"g");
	children = node_contents.match(match_regex);
	
	//removing preceding characters because JS doesn't support look behind
	strip_regex_pattern = "\n {"+child_indent_level+","+child_indent_level+"}(?! )";
	strip_regex = new RegExp(strip_regex_pattern,"g");
	
	var i;
	
	for(i=0;i<children.length;i++)
	{
		children[i] = children[i].replace(strip_regex,"");
	}
	return children;
}

function getChildren_UI()
{
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	children = getChildren(node,source);
	alert(children);
	alert(children.length);
	var j;
	
	for(j=0;j<children.length;j++){
		alert(j+".>"+children[j]+"<");
		alert(extractNode(children[j], extractNode(node,source)));
	}
}


function replaceNode(node, source, new_node_content) { //note: this function will directly replace contents without checking correctness
	node_content = extractNode(node, source);
	return source.replace(node_content,new_node_content);
	}
	
function replaceNode_UI() {
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	new_node_content = document.getElementById("new-stack").value;
	
	document.getElementById("stack-yaml").value = replaceNode(node, source, new_node_content);;
}


function setChild(node, source, child, child_contents){ //NOTE:if child is not found, nothing is changed
	node_contents = extractNode(node, source);
	new_node_contents = replaceNode(child, node_contents, child_contents);
	new_source = replaceNode(node, source, new_node_contents);
	return new_source;
}


function setChild_UI() {
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	child = document.getElementById("node2").value;
	new_child_contents = document.getElementById("new-stack").value;
	
	document.getElementById("stack-yaml").value = setChild(node, source, child, new_child_contents);
}


function renameNode(node, source, new_name) { //not tested!
	node_content = extractNode(node, source);
	edited_node_content = node_content.replace(node+":", new_name+":");
	return replaceNode(node, source, edited_node_content);
}

function renameNode_UI()
{
	node = document.getElementById("node").value;
	source = document.getElementById("stack-yaml").value;
	new_name = document.getElementById("node2").value;
	
	document.getElementById("stack-yaml").value = renameNode(node, source, new_name);
}
	

 </script>
 </head>
<body>
<textarea id="stack-yaml" rows="30" cols="80">#
# This is a hello world HOT template just defining a single compute
# server.
#
heat_template_version: 2013-05-23

description: >
  Hello world HOT template that just defines a single server.
  Contains just base features to verify base HOT support.
parameters:
  key_name:
    type: string
    description: Name of an existing key pair to use for the server
    constraints:
      - custom_constraint: nova.keypair
  flavor:
    type: string
    description: Flavor for the server to be created
    default: m1.small
    constraints:
      - custom_constraint: nova.flavor
  image:
    type: string
    description: Image ID or image name to use for the server
    constraints:
      - custom_constraint: glance.image
  admin_pass:
    type: string
    description: Admin password
    hidden: true
    constraints:
      - length: { min: 6, max: 8 }
        description: Password length must be between 6 and 8 characters
      - allowed_pattern: "[a-zA-Z0-9]+"
        description: Password must consist of characters and numbers only
      - allowed_pattern: "[A-Z]+[a-zA-Z0-9]*"
        description: Password must start with an uppercase character
  db_port:
    type: number
    description: Database port number
    default: 50000
    constraints:
      - range: { min: 40000, max: 60000 }
        description: Port number must be between 40000 and 60000

resources:
  server:
    type: OS::Nova::Server
    properties:
      key_name: { get_param: key_name }
      image: { get_param: image }
      flavor: { get_param: flavor }
      admin_pass: { get_param: admin_pass }
      user_data:
        str_replace:
          template: |
            #!/bin/bash
            echo db_port
          params:
            db_port: { get_param: db_port }

outputs:
  server_networks:
    description: The networks of the deployed server
    value: { get_attr: [server, networks] }</textarea>
<textarea id="new-stack" rows="30" cols="70"></textarea>
<br><br>
<input id="node"></input>
<input value="Remove Node" type="button" onclick="removeNode_UI()"></input>
<input value="Indent Level" type="button" onclick="getIndentLevel_UI()"></input>
<input value="Next Node" type="button" onclick="getNextNode_UI()"></input>
<input value="Extract Node" type="button" onclick="extractNode_UI()"></input>
<input value="Copy Node" type="button" onclick="copyNode_UI()"></input>
<input value="Get Children" type="button" onclick="getChildren_UI()"></input>
<input value="Replace Node" type="button" onclick="replaceNode_UI()"></input>
<br><br>
<input id="node2"></input>
<input value="Set Child" type="button" onclick="setChild_UI()"></input>
<input value="Rename Node" type="button" onclick="renameNode_UI()"></input>
</body>
</html>